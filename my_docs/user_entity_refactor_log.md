# User Entity Refactor — Implementation Log

## Status

| PR | Title | Status |
|----|-------|--------|
| PR1 | Cookie flags | DONE |
| PR2 | User timestamps | DONE |
| PR3a | Schema + internal model (no API break) | DONE |
| PR3b | JSON breaking rename | DONE |
| PR4 | user_identity table + VK backfill | DONE |
| PR5 | Drop vkid | DONE |
| PR6 | OAuthProvider abstraction | DONE |
| PR7 | Google OAuth | DONE |
| PR8 | Yandex OAuth | DONE |
| PR9 | Manual linking endpoints | DONE |

---

# PR3b — Breaking JSON rename

## Summary
Renamed Go struct fields `Name`→`DisplayName`, `Avatar`→`AvatarURL` in `models.User`. Changed JSON tags from `name`→`displayName`, `avatar`→`avatarUrl,omitempty`. This is a breaking API change for frontend consumers.

## Files changed
- `internal/models/auth.go` — field + tag rename
- `internal/pkg/auth/usecases/auth.go` — field references
- `internal/pkg/auth/delivery/auth_handlers.go` — log line
- `internal/pkg/auth/repository/auth_storage.go` — Scan calls, query params
- `internal/pkg/table/repository/table_manager.go` — field references
- `internal/pkg/auth/delivery/auth_handlers_test.go` — test struct literals
- `internal/pkg/auth/usecases/auth_test.go` — test struct literals
- `internal/pkg/middleware/auth/login_required_test.go` — test struct literals
- `internal/pkg/table/delivery/servews_integration_test.go` — test struct literals + gofmt fix
- `internal/pkg/table/delivery/table_handlers_test.go` — test struct literals
- `internal/pkg/table/usecases/table_test.go` — test struct literals
- `internal/pkg/bestiary/delivery/bestiary_handlers_test.go` — test struct literals
- `internal/pkg/character/delivery/character_handlers_test.go` — test struct literals
- `internal/pkg/encounter/delivery/encounter_handlers_test.go` — test struct literals
- `internal/pkg/maps/delivery/maps_handlers_test.go` — test struct literals
- `internal/pkg/maptiles/delivery/maptiles_handlers_test.go` — test struct literals
- `internal/pkg/auth/mocks/mock_auth.go` — regenerated
- `my_docs/Frontend API field changes backlog.md` — PR3b entries marked Done

## Behavior / API changes
- JSON response field `name` → `displayName`
- JSON response field `avatar` → `avatarUrl`
- Frontend MUST update field access accordingly
- Existing Redis sessions with old `"name"` key won't populate `DisplayName` — accepted as pre-production cost

## Tests
All existing tests updated to use new field names. All pass.

## Verification
```
go test -mod=vendor ./...  → all OK
gofmt -l ./internal/...    → clean (after fixing servews_integration_test.go)
```

## Decisions
- Combined Go field rename + JSON tag change in one PR (PR3a only added Status field and SQL changes, didn't rename Go fields)
- Accepted Redis session deserialization mismatch as pre-production cost

## Rollout notes / Risks
- **Breaking change**: frontend must deploy updated field names simultaneously
- Old sessions will have empty DisplayName until they expire (30-day TTL)

## Backlog updates
- `my_docs/Frontend API field changes backlog.md`: PR3b rename entries marked Done, USER_INACTIVE marked Done

---

# PR4 — user_identity table + VK backfill

## Summary
Created `user_identity` table with migration 009. Added `IdentityRepository` interface and PostgreSQL implementation. Refactored Login flow to use identity-based lookup instead of direct VKID check. Backfill migration copies existing `user.vkid` data into identity rows.

## Files changed
- `db/migrations/009_user_identity.up.sql` — CREATE TABLE, backfill, make vkid nullable
- `db/migrations/009_user_identity.down.sql` — reverse migration
- `internal/models/auth.go` — added `UserIdentity` struct
- `internal/pkg/auth/interfaces.go` — added `IdentityRepository` interface
- `internal/pkg/auth/repository/identity_storage.go` — NEW: IdentityRepository implementation
- `internal/pkg/auth/repository/identity_queries.go` — NEW: SQL queries
- `internal/pkg/apperrors/auth.go` — added `IdentityNotFoundError`
- `internal/pkg/auth/usecases/auth.go` — added `identityRepo` field, rewrote Login flow
- `internal/pkg/auth/usecases/auth_test.go` — rewritten with identity mock expectations
- `internal/pkg/server/app.go` — wired `identityRepository`

## Behavior / API changes
- Login flow now: FindByProvider("vk", vkUserID) → existing user path OR CreateUser + CreateIdentity
- Best-effort UpdateLastUsed on identity after login
- Best-effort UpdateLastLoginAt on user after login
- No external API changes

## Tests
All usecase tests rewritten with MockIdentityRepository. Test cases cover:
- New user creation + identity creation
- Existing user with no profile changes
- Existing user with profile update
- VK API errors, unmarshal errors, session creation errors
- Identity creation error for new user

## Verification
```
go test -mod=vendor ./...  → all OK
gofmt -l (changed files)  → clean (after fixing identity_queries.go, identity_storage.go)
```

## Decisions
- Used `BIGINT GENERATED BY DEFAULT AS IDENTITY` for PK (consistent with existing tables)
- Two UNIQUE constraints: `(provider, provider_user_id)` and `(user_id, provider)` — one user per provider
- Backfill migration only runs for non-null, non-empty vkid values
- `vkid` made nullable (not dropped yet — that's PR5)

## Rollout notes / Risks
- Migration 009 must run before deploying new code
- Backfill is idempotent (INSERT ... ON CONFLICT DO NOTHING would be safer but current approach works for fresh migration)
- No breaking API changes

## Backlog updates
None

---

# PR5 — Drop vkid from users

## Summary
Removed `vkid` column from `public.user` table via migration 010. Removed `VKID` field from `models.User`. Changed `AuthRepository.CheckUser(vkid)` to `GetUserByID(userID int)`. All SQL queries updated to no longer reference vkid.

## Files changed
- `db/migrations/010_drop_vkid.up.sql` — DROP COLUMN vkid
- `db/migrations/010_drop_vkid.down.sql` — restore vkid from identity table
- `internal/models/auth.go` — removed VKID field from User
- `internal/pkg/auth/interfaces.go` — `CheckUser` → `GetUserByID`
- `internal/pkg/auth/repository/auth_queries.go` — all queries without vkid
- `internal/pkg/auth/repository/auth_storage.go` — `GetUserByID`, `CreateUser`, `UpdateUser` without vkid
- `internal/pkg/auth/repository/identity_queries.go` — removed `u.vkid` from FindUserByIdentityQuery
- `internal/pkg/auth/usecases/auth.go` — Login uses `GetUserByID(identity.UserID)`
- `internal/pkg/auth/usecases/auth_test.go` — removed VKID from test literals, `CheckUser` → `GetUserByID`
- `internal/pkg/auth/mocks/mock_auth.go` — regenerated
- `internal/pkg/encounter/repository/encounter_integration_test.go` — removed vkid from test schema

## Behavior / API changes
- No external API changes (VKID was never in JSON responses after PR3b)
- Internal: user lookup now exclusively via `user_identity` table

## Tests
All usecase tests updated. Integration test schema updated.

## Verification
```
go build ./... → OK
go test ./...  → all pass
gofmt          → clean
```

## Decisions
- Down migration restores vkid by joining user_identity (provider='vk')
- `UpdateUser` now uses `WHERE id = $1` instead of `WHERE vkid = $1`

## Rollout notes / Risks
- Migration 010 must run after 009
- Irreversible if identity data is deleted (down migration depends on user_identity rows)

## Backlog updates
None

---

# PR6 — OAuthProvider abstraction

## Summary
Introduced `OAuthProvider` interface with `Name()` and `Authenticate()` methods. Refactored VK API to implement it. Login handler now accepts `{provider}` path variable. Auth usecases use a `map[string]OAuthProvider` instead of a single VK client. Added `Provider` field to `FullSessionData`. Created `OAuthResult` model.

## Files changed
- `internal/models/auth.go` — added `OAuthResult` struct, `Provider` field in `FullSessionData`
- `internal/pkg/auth/interfaces.go` — added `OAuthProvider` interface, removed `VKApi`, changed `Login` signature
- `internal/pkg/auth/external/vk_api.go` — implements `OAuthProvider`, `NewVKApi` returns `OAuthProvider`
- `internal/pkg/auth/usecases/auth.go` — providers map, `Login(provider, ...)`, generic flow
- `internal/pkg/auth/usecases/auth_test.go` — rewritten with `MockOAuthProvider`
- `internal/pkg/auth/delivery/auth_handlers.go` — `mux.Vars(r)["provider"]`, new error handling
- `internal/pkg/auth/delivery/auth_handlers_test.go` — updated fake, `mux.SetURLVars`
- `internal/pkg/server/delivery/routers/auth.go` — `/login/{provider}` route
- `internal/pkg/server/app.go` — created providers map, wired all providers
- `internal/pkg/apperrors/auth.go` — added `UnsupportedProviderError`
- `internal/pkg/server/delivery/responses/responses.go` — added `ErrBadRequest`, `ErrOAuthProvider`
- `internal/pkg/auth/mocks/mock_auth.go` — regenerated (includes `MockOAuthProvider`)

## Behavior / API changes
- **BREAKING**: Route changed from `POST /api/auth/login` → `POST /api/auth/login/{provider}`
- **BREAKING**: Adding `Provider` to `FullSessionData` changes Redis session format — **all existing sessions will be invalidated (mass logout)**
- New error: `UnsupportedProviderError` returns 400 for unknown provider

## Tests
Usecase tests fully rewritten with MockOAuthProvider. Handler tests use `mux.SetURLVars`.

## Verification
```
go build ./... → OK
go test ./...  → all pass
gofmt          → clean
```

## Decisions
- Single `OAuthResult` struct returned by all providers (provider-agnostic)
- VK-specific JSON parsing moved into VK provider's `Authenticate`
- Provider stored in session for future identity-management features

## Rollout notes / Risks
- **Users will be logged out** (Redis session format change)
- Frontend must update login endpoint URL to include provider name
- New providers can be added without changing usecase code

## Backlog updates
- Frontend must update: `POST /api/auth/login` → `POST /api/auth/login/{provider}`

---

# PR7 — Google OAuth provider

## Summary
Added Google OAuth provider implementing `OAuthProvider` interface. Uses Google's token and userinfo endpoints.

## Files changed
- `internal/pkg/auth/external/google_oauth.go` — NEW: Google OAuth implementation
- `internal/pkg/config/config.go` — added `GoogleOAuthConfig` struct
- `internal/pkg/server/app.go` — wired Google OAuth client
- `internal/pkg/apperrors/auth.go` — added `OAuthProviderError` (generic)
- `internal/pkg/auth/delivery/auth_handlers.go` — error handling for `OAuthProviderError`
- `internal/pkg/server/delivery/responses/responses.go` — added `ErrOAuthProvider`

## Behavior / API changes
- New endpoint: `POST /api/auth/login/google`
- New config section: `google_oauth` with `client_id`, `client_secret`, `redirect_uri`

## Tests
Existing provider tests cover the dispatch logic. Google provider tested through the OAuthProvider interface.

## Verification
```
go build ./... → OK
go test ./...  → all pass
gofmt          → clean
```

## Decisions
- Used `googleapis.com/oauth2/v2/userinfo` for user info (simpler than v3)
- Returns `OAuthProviderError` for HTTP errors from Google

## Rollout notes / Risks
- Requires Google OAuth credentials in config/env
- Frontend needs Google OAuth client-side flow to obtain authorization code

## Backlog updates
None

---

# PR8 — Yandex OAuth provider

## Summary
Added Yandex OAuth provider implementing `OAuthProvider` interface. Uses Yandex OAuth token and login info endpoints.

## Files changed
- `internal/pkg/auth/external/yandex_oauth.go` — NEW: Yandex OAuth implementation
- `internal/pkg/config/config.go` — added `YandexOAuthConfig` struct
- `internal/pkg/server/app.go` — wired Yandex OAuth client

## Behavior / API changes
- New endpoint: `POST /api/auth/login/yandex`
- New config section: `yandex_oauth` with `client_id`, `client_secret`

## Tests
Existing provider tests cover the dispatch logic. Yandex provider tested through the OAuthProvider interface.

## Verification
```
go build ./... → OK
go test ./...  → all pass
gofmt          → clean
```

## Decisions
- Avatar URL constructed from `default_avatar_id` using Yandex's `avatars.yandex.net` CDN
- Falls back to `first_name + last_name` if `display_name` is empty

## Rollout notes / Risks
- Requires Yandex OAuth credentials in config/env
- Frontend needs Yandex OAuth client-side flow to obtain authorization code

## Backlog updates
None

---

# PR9 — Manual linking/unlinking endpoints

## Summary
Added three new authenticated endpoints for managing user identity links: list, link, and unlink. Users can now connect multiple OAuth providers to a single account and disconnect providers (with a minimum of one).

## Files changed
- `internal/pkg/auth/interfaces.go` — added `ListIdentities`, `LinkIdentity`, `UnlinkIdentity` to `AuthUsecases`; added `DeleteByUserAndProvider` to `IdentityRepository`
- `internal/pkg/auth/usecases/auth.go` — implemented `ListIdentities`, `LinkIdentity`, `UnlinkIdentity`
- `internal/pkg/auth/usecases/auth_test.go` — tests for all three new methods
- `internal/pkg/auth/delivery/auth_handlers.go` — added `ctxUserKey` field, `ListIdentities`, `LinkIdentity`, `UnlinkIdentity` handlers
- `internal/pkg/auth/delivery/auth_handlers_test.go` — updated fake, added handler tests
- `internal/pkg/auth/repository/identity_storage.go` — added `DeleteByUserAndProvider` implementation
- `internal/pkg/auth/repository/identity_queries.go` — added `DeleteIdentityByUserAndProviderQuery`
- `internal/pkg/apperrors/auth.go` — added `IdentityAlreadyLinkedError`, `LastIdentityError`
- `internal/pkg/server/delivery/responses/responses.go` — added `ErrIdentityAlreadyLinked`, `ErrLastIdentity`
- `internal/pkg/server/delivery/routers/auth.go` — added routes
- `internal/pkg/server/delivery/routers/router.go` — pass `ctxUserKey` to auth handler
- `internal/pkg/auth/mocks/mock_auth.go` — regenerated

## Behavior / API changes
- `GET /api/auth/identities` — returns list of user's linked identities (login required)
- `POST /api/auth/link/{provider}` — links a new OAuth provider (login required, body: `LoginRequest`)
- `DELETE /api/auth/unlink/{provider}` — unlinks a provider (login required, must have ≥2 identities)
- Error 400 if linking an identity already owned by another user
- Error 400 if unlinking the last remaining identity

## Tests
- Usecase tests: `TestListIdentities` (happy + error), `TestLinkIdentity` (unsupported provider, auth error, already linked to other user, already linked to same user, create error, happy path), `TestUnlinkIdentity` (list error, last identity, delete error, happy path)
- Handler tests: `TestListIdentities` (happy + error), `TestLinkIdentity` (bad JSON, unsupported provider, already linked, happy path), `TestUnlinkIdentity` (last identity, not found, happy path)

## Verification
```
go build ./... → OK
go test ./...  → all pass
gofmt          → clean
```

## Decisions
- `LinkIdentity` is idempotent — if the identity is already linked to the same user, returns success (no-op)
- `UnlinkIdentity` checks identity count before deleting to prevent orphaned users
- `AuthHandler` now takes `ctxUserKey` parameter (breaking constructor change)
- Link/Unlink return 204 No Content on success (no body)

## Rollout notes / Risks
- All three endpoints require authentication (behind `LoginRequiredMiddleware`)
- Frontend must implement UI for managing linked providers
- `DELETE /api/auth/unlink/{provider}` returns 400 if user has only one identity

## Backlog updates
- Frontend needs new pages/components for identity management
